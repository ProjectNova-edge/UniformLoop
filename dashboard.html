<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Account</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Welcome to Your Dashboard</h1>
  <button onclick="signOutUser()">Logout</button>

  <h2>Post a New Listing</h2>
  <form id="listingForm">
    <input type="text" id="schoolInput" placeholder="School Name" required />
    <input type="text" id="sizeInput" placeholder="Size" required />
    <select id="genderInput" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Unisex">Unisex</option>
    </select>
    <input type="text" id="locationInput" placeholder="Location" required />
    <input type="text" id="priceInput" placeholder="Price (or Free)" required />
    <textarea id="extraInput" placeholder="Extra Details (optional)"></textarea>
    <input type="file" id="photoInput" accept="image/*" multiple required />
    <button type="submit">Submit Listing</button>
  </form>

  <h2>Your Listings</h2>
  <div id="userListings"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCF35AKe2AHRXaXX_0d3lQi9bpqM_C2NaQ",
      authDomain: "schooluniformsapp.firebaseapp.com",
      projectId: "schooluniformsapp",
      storageBucket: "schooluniformsapp.appspot.com",
      messagingSenderId: "660528209566",
      appId: "1:660528209566:web:5c19e23b57ce2b8039258f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUser = null;
    let allListings = JSON.parse(localStorage.getItem("listings")) || [];

    const form = document.getElementById("listingForm");
    const container = document.getElementById("userListings");

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        renderListings();
      } else {
        window.location.href = "index.html";
      }
    });

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const files = document.getElementById("photoInput").files;
      if (!files.length || files.length > 5) {
        alert("Please select 1 to 5 photos.");
        return;
      }

      const photoURLs = [];

      for (let i = 0; i < files.length; i++) {
        const photoRef = storageRef(storage, `photos/${currentUser.uid}/${Date.now()}_${files[i].name}`);
        const snapshot = await uploadBytes(photoRef, files[i]);
        const url = await getDownloadURL(snapshot.ref);
        photoURLs.push(url);
      }

      const newListing = {
        id: Date.now(),
        userId: currentUser.uid,
        school: document.getElementById("schoolInput").value.trim(),
        size: document.getElementById("sizeInput").value.trim(),
        gender: document.getElementById("genderInput").value,
        location: document.getElementById("locationInput").value.trim(),
        price: document.getElementById("priceInput").value.trim(),
        extra: document.getElementById("extraInput").value.trim(),
        photoURLs
      };

      allListings.push(newListing);
      localStorage.setItem("listings", JSON.stringify(allListings));
      renderListings();
      form.reset();
    });

    function renderListings() {
      container.innerHTML = "";
      const userListings = allListings.filter(listing => listing.userId === currentUser.uid);

      if (userListings.length === 0) {
        container.innerHTML = "<p>No listings yet.</p>";
        return;
      }

      userListings.forEach(listing => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          ${listing.photoURLs.map(url => `<img src="${url}" alt="Item photo" style="max-width:150px;" />`).join('')}
          <h3>${listing.school}</h3>
          <p><strong>Size:</strong> ${listing.size}</p>
          <p><strong>Gender:</strong> ${listing.gender}</p>
          <p><strong>Location:</strong> ${listing.location}</p>
          <p><strong>Price:</strong> ${listing.price}</p>
          ${listing.extra ? `<p><strong>Extra:</strong> ${listing.extra}</p>` : ""}
          <button onclick="editListing(${listing.id})">Edit</button>
          <button onclick="deleteListing(${listing.id})">Delete</button>
        `;
        container.appendChild(div);
      });
    }

    window.deleteListing = function(id) {
      allListings = allListings.filter(item => item.id !== id);
      localStorage.setItem("listings", JSON.stringify(allListings));
      renderListings();
    };

    window.editListing = function(id) {
      const listing = allListings.find(item => item.id === id);
      if (listing) {
        document.getElementById("schoolInput").value = listing.school;
        document.getElementById("sizeInput").value = listing.size;
        document.getElementById("genderInput").value = listing.gender;
        document.getElementById("locationInput").value = listing.location;
        document.getElementById("priceInput").value = listing.price;
        document.getElementById("extraInput").value = listing.extra;
        deleteListing(id);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    };

    window.signOutUser = function () {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    };
  </script>
</body>
</html>
